<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>【NanoPi R2S旁路网关系列】1. 基础配置、Wireguard | Linkzz's Blog</title><meta name=keywords content="openwrt,wireguard"><meta name=description content="NanoPi R2S 旁路网关"><meta name=author content="Linkzz"><link rel=canonical href=https://linkzz.eu.org/posts/openwrt-wireguard/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.4879321a85a1040010a43a83d47225cf717d7cb0d8f565bf0bfabfd9db2f9183.css integrity="sha256-SHkyGoWhBAAQpDqD1HIlz3F9fLDY9WW/C/q/2dsvkYM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=https://linkzz.eu.org/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://linkzz.eu.org/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://linkzz.eu.org/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://linkzz.eu.org/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://linkzz.eu.org/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: rgb(29, 30, 32);--entry: rgb(46, 46, 51);--primary: rgb(218, 218, 219);--secondary: rgb(155, 156, 157);--tertiary: rgb(65, 66, 68);--content: rgb(196, 196, 197);--hljs-bg: rgb(46, 46, 51);--code-bg: rgb(55, 56, 62);--border: rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-123-45','auto');ga('send','pageview');}</script><meta property="og:title" content="【NanoPi R2S旁路网关系列】1. 基础配置、Wireguard"><meta property="og:description" content="NanoPi R2S 旁路网关"><meta property="og:type" content="article"><meta property="og:url" content="https://linkzz.eu.org/posts/openwrt-wireguard/"><meta property="og:image" content="https://linkzz.eu.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-08T13:10:22+08:00"><meta property="article:modified_time" content="2023-08-08T13:10:22+08:00"><meta property="og:site_name" content="Linkzz's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://linkzz.eu.org/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="【NanoPi R2S旁路网关系列】1. 基础配置、Wireguard"><meta name=twitter:description content="NanoPi R2S 旁路网关"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"【NanoPi R2S旁路网关系列】1. 基础配置、Wireguard","item":"https://linkzz.eu.org/posts/openwrt-wireguard/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"【NanoPi R2S旁路网关系列】1. 基础配置、Wireguard","name":"【NanoPi R2S旁路网关系列】1. 基础配置、Wireguard","description":"NanoPi R2S 旁路网关","keywords":["openwrt","wireguard"],"articleBody":"前言 自己现在家中有一台自己组的 All in One 服务器，系统是 PVE，在上面跑了个虚拟机 OpenWRT 承担家里旁路网关的功能，起初用的国内不知道谁编译的版本，后面自己编译了官方 22.05 版本，添加上自己想要的功能一直稳定运行了 2 年，但是 All in One 最大的问题就是宿主机重启，因为最近折腾显卡直通需要不断重启 PVE，这时要是家里领导在打王者掉线了就有的好受了，所以趁着 618（没错 618 到现在才开始折腾）下手了一台 R2S，彻底杜绝家里领导找茬的机会。\n需求 基本是目前虚拟机上 OpenWRT 功能的移植：\n Wireguard  能通过 Wireguard 结合家里的公网 ip 从公司访问家里网络\n自定义域名  通过自定义域名和 Nginx 实现域名访问自部署的服务，不用记 ip 和端口，不用维护 dashboard 服务\nDDNS 服务  自动更新公网 ip，防止每次拨号之后 Wireguard 失联\nKMS 服务  windows 激活\n懂的都懂需求  如题，不做展开\nR2S 系统安装 下面我们就一步步实现上面的需求，首先是系统的选用，依照官网介绍选择官方自己维护编译的 OpenWRT 发行版，对与 Docker 目前是没有需求的，但为了防止以后有需要的时候还得自己安装，所以我们直接一步到位，选择官方基于 OpenWrt 22.03 构建的带 Docker 的FriendlyWrt 固件\n接下来就是烧录固件到 TF 卡，插电开机。\n系统配置 插上网线，更改电脑 ip 为192.168.2.100，系统默认 ip 为192.168.2.1，配置的客户机 ip 也要在192.168.2.0/24网段才能互访，现在使用 ssh 访问 openwrt 后台:\nssh root@192.168.2.1 默认密码为password 首先改个安全密码\npasswd root 修改 ip 地址 首先修改 ip 使其具有互联网访问能力\nvi /etc/config/network 找到config interface 'lan'处，修改如下:\nconfig interface 'lan' option device 'br-lan' option proto 'static' option netmask '255.255.255.0' option ip6assign '60' option ipaddr '192.168.5.99' option gateway '192.168.5.1' 上面掩码和网关需要依据家里的网络环境修改，我的虚拟机 openwrt 目前具有良好的网络访问能力，所以网关设置为了虚拟机 openwrt 的 ip，还有要注意的就是 ip 不能冲突了。\n修改 DNS vi /etc/config/dhcp dnsmasq 配置选项下新增list server '192.168.5.1' dncp ‘lan'配置选项下 option ignore 要改为 1，对应 web 界面的忽略此接口\nconfig dnsmasq option domainneeded '1' option boguspriv '1' option filterwin2k '0' option localise_queries '1' option rebind_protection '1' option rebind_localhost '1' option local '/lan/' option domain 'lan' option expandhosts '1' option nonegcache '0' option authoritative '1' option readethers '1' option leasefile '/tmp/dhcp.leases' option resolvfile '/tmp/resolv.conf.d/resolv.conf.auto' option nonwildcard '1' option localservice '1' option ednspacket_max '1232' option confdir '/tmp/dnsmasq.d' list server '192.168.5.1' config dhcp 'lan' option interface 'lan' option start '100' option limit '150' option leasetime '12h' option dhcpv4 'server' option dhcpv6 'server' option ra 'server' list ra_flags 'managed-config' list ra_flags 'other-config' option ignore '1' config dhcp 'wan' option interface 'wan' option ignore '1' config odhcpd 'odhcpd' option maindhcp '0' option leasefile '/tmp/hosts/odhcpd' option leasetrigger '/usr/sbin/odhcpd-update' option loglevel '4' 执行命令检测互谅网访问能力\ncurl https://baidu.com 证书报错\nroot@FriendlyWrt:~# curl https://baidu.com curl: (60) Cert verify failed: BADCERT_FUTURE More details here: https://curl.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. 网络是联通了互联网的，其他机器也能正常上网，查了一下是机器时间有问题：\nroot@FriendlyWrt:~# date Fri Jan 22 17:07:48 CST 2016 查看 ntp 服务\nroot@FriendlyWrt:~# ps | grep ntp 3942 root 2592 S {ntpd} /sbin/ujail -t 5 -n ntpd -U ntp -G ntp -C /etc/capabilities/ntpd.json -c -u -r /bin/ubus -r /usr/bin/env -r /usr/bin/jshn -r /usr/sbin/ntpd-hotplug -r /usr/share/libubox/jshn.s 3954 ntp 1320 S /usr/sbin/ntpd -n -N -S /usr/sbin/ntpd-hotplug -p 0.openwrt.pool.ntp.org -p 1.openwrt.pool.ntp.org -p 2.openwrt.pool.ntp.org -p 3.openwrt.pool.ntp.org 5678 root 1572 S grep ntp 修改 ntp 为阿里 ntp\nvi /etc/config/system config system option log_size '64' option urandom_seed '0' option hostname 'FriendlyWrt' option ttylogin '1' option timezone 'CST-8' option zonename 'Asia/Shanghai' config timeserver 'ntp' option enabled '1' option enable_server '0' list server 'ntp.aliyun.com' list server 'ntp1.aliyun.com' list server 'ntp2.aliyun.com' list server 'ntp3.aliyun.com' config led 'led_wan' option name 'WAN' option sysfs 'wan_led' option trigger 'netdev' option mode 'link tx rx' option dev 'eth0' config led 'led_lan' option name 'LAN' option sysfs 'lan_led' option trigger 'netdev' option mode 'link tx rx' option dev 'eth1' 重启服务\n/etc/init.d/sysntpd restart 查看时间\nroot@FriendlyWrt:~# date Mon Aug 7 14:56:10 CST 2023 查看证书问题是否报错\nroot@FriendlyWrt:~# curl https://baidu.com  302 Found bgcolor=\"white\" 302 Found bfe/1.0.8.18   正常的 302 重定向\n修改源（可选） FriendlyWrt 固件使用的是腾讯源, 由于虚拟机 openwrt 使用的是清华源，所以保持一致以免软件包版本冲突:\nsed -i -e 's/mirrors.cloud.tencent.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/opkg/distfeeds.conf 更新索引\nopkg update Wireguard 安装 系统配置好之后添加 Wireguard 内核模块和工具包\nopkg install kmod-wireguard wireguard-tools 检查内核是否加载了 wireguard 模块\nlsmod | grep wireguard 出现如下字样说明成功加载 wireguard 模块\nroot@FriendlyWrt:~# lsmod | grep wireguard wireguard 77824 0 libchacha20poly1305 16384 1 wireguard libcurve25519_generic 40960 1 wireguard udp_tunnel 24576 3 l2tp_core,wireguard,vxlan ip6_udp_tunnel 16384 3 l2tp_core,wireguard,vxlan 生成公私钥对\nwg genkey | tee privatekey | wg pubkey  publickey 以上命令生成公私钥文件分别存储到privatekey和publickey中 配置 wireguard 接口\nvi /etc/config/network 末尾添加以下内容, 大括号里的内容记得替换\nconfig interface 'wg0' option proto 'wireguard' option private_key '{private_key}' option listen_port '25378' list addresses '192.168.7.1' 重启 network 服务\n/etc/init.d/network restart 查看 wireguard 状态\nroot@FriendlyWrt:~# wg interface: wg0 public key: fTaGpi1YIlS6RTsWSjsHoWMHY1drWe/CTTOK/EUFTUE= private key: (hidden) listening port: 25378 以上步骤也可以在 web 端进行，web 端需要安装 luci 支持：\nopkg install luci-i18n-wireguard-zh-cn Web 端\n公网访问 目前我的家庭网络拓扑如下：\n坐标上海，电信光猫拨号，有公网 ip，可以看到虚拟机 openwrt 位于 2 级路由之下，这是要将 openwrt 的端口转发出去需要二级路由AC-68U转发一次，再经过光猫转发一次，较为麻烦，所以在安全的前提下我在电信 app 上面将二级路由 DMZ 出去，开启二级路由防火墙，再使用二级路由的端口转发功能将 wireguard 端口转发出去即可，这样公网接管了二级路由的所有端口，以后也方便配置各种端口 转发。\n 注意千万别将 openwrt 的 web 端口 80 和 ssh 端口 22 转发到公网，这样黑客扫到开盒是早晚的事。\n windows 客户端配置 windows 使用官方的wireguard 客户端，新建空隧道：\n会自动生成公私钥对，然后填写配置:\n[Interface] PrivateKey = {privatekey} Address = 192.168.7.2/32 DNS = 192.168.7.1 MTU = 1300 [Peer] PublicKey = {openwrt_publickey} AllowedIPs = 192.168.7.0/24,192.168.5.0/24 Endpoint = {公网ip}:{转发端口} PersistentKeepalive = 25  Interface 配置  PrivateKey: 自动生成的私钥，不需要修改 Address: 当前节点的 ip 地址，需要和后面配置的对端地址相同 DNS: 使用 openwrt 提供的 dns 服务，用到自定义域名的时候有用，在公司也能访问内网的域名 MTU: 默认 1500，影响发包的性能，这个需要自己去试，小一点可以提升一点网络性能，不是太在意的话默认 1500 即可。   Peer 配置  PublicKey: 填写 openwrt 的公钥 AllowedIPs: 允许访问的网段，这里填写家里内网网段即可，如果需要 wireguard 作为所有网段隧道填写 0.0.0.0/0，需要 openwrt 防火墙配置正确才能访问互联网。 Endpoint: 公网转发出来的 wireguard 地址和端口 PersistentKeepalive: 保活时间，设置为 25s    配置对端 windows 配置完之后还没完，openwrt 上还要进行相应配置：\nvi /etc/config/network 添加如下配置：\nconfig wireguard_wg0 option route_allowed_ips '1' option persistent_keepalive '25' option public_key 'VM3DZLzhtpkE0w1VgUmeRSuoX/6mgVMlJWtnynomUXg=' option description 'Worklaptop' list allowed_ips '192.168.7.2' 重启网络服务\n/etc/init.d/network restart windows 客户端点击连接：\n流量收发正常即表示连接成功，ping 一下网关测试一下：\n对端连接成功，但是访问内网192.168.5.0/24网段显然是不行的，这是因为防火墙将来自 wireguard 的网络访问转发给 lan 接口，下面我们就开始配置防火墙。\n防火墙配置 通过 openwrt Web 端，“网络” - “防火墙” - “NAT 规则”，配置一个地址的 nat，转发来自192.168.7.0/24网段的流量到 lan 接口，这样即可实现内网网段的访问，当然如果需要 wireguard 具备访问所有网段的能力，将目标地址设为任意即可。\n小结 本章我们实现了 openwrt 的第一个功能，外网访问内网即 VPN 的功能，让我们可以不用担心各种端口转发暴露内网风险，实现方便安全的访问家庭内网的能力，接下来我们继续实现第二个需求，自定义内网域名。\n","wordCount":"775","inLanguage":"en","datePublished":"2023-08-08T13:10:22+08:00","dateModified":"2023-08-08T13:10:22+08:00","author":{"@type":"Person","name":"Linkzz"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://linkzz.eu.org/posts/openwrt-wireguard/"},"publisher":{"@type":"Organization","name":"Linkzz's Blog","logo":{"@type":"ImageObject","url":"https://linkzz.eu.org/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><header class=header><nav class=nav><div class=logo><a href=https://linkzz.eu.org/ accesskey=h title="Linkzz's Blog (Alt + H)">Linkzz's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://linkzz.eu.org/archives/ title=文章><span>文章</span></a></li><li><a href=https://linkzz.eu.org/tags/ title=标签><span>标签</span></a></li><li><a href=https://linkzz.eu.org/index.xml title=订阅><span>订阅</span></a></li><li><a href=https://huangjing.me title=友站><span>友站</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://linkzz.eu.org/>Home</a></div><h1 class=post-title>【NanoPi R2S旁路网关系列】1. 基础配置、Wireguard</h1><div class=post-description>NanoPi R2S 旁路网关</div><div class=post-meta><span title="2023-08-08 13:10:22 +0800 CST">2023-08-08</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;775 words&nbsp;·&nbsp;Linkzz</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#系统配置>系统配置</a><ul><li><a href=#修改-ip-地址>修改 ip 地址</a></li><li><a href=#修改-dns>修改 DNS</a></li><li><a href=#修改源可选>修改源（可选）</a></li></ul></li><li><a href=#wireguard>Wireguard</a><ul><li><a href=#安装>安装</a></li><li><a href=#公网访问>公网访问</a></li><li><a href=#windows-客户端配置>windows 客户端配置</a></li><li><a href=#配置对端>配置对端</a></li><li><a href=#防火墙配置>防火墙配置</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h1><p>自己现在家中有一台自己组的 All in One 服务器，系统是 PVE，在上面跑了个虚拟机
OpenWRT
承担家里旁路网关的功能，起初用的国内不知道谁编译的版本，后面自己编译了官方 22.05
版本，添加上自己想要的功能一直稳定运行了 2 年，但是 All in One
最大的问题就是宿主机重启，因为最近折腾显卡直通需要不断重启
PVE，这时要是家里领导在打王者掉线了就有的好受了，所以趁着 618（没错 618
到现在才开始折腾）下手了一台 R2S，彻底杜绝家里领导找茬的机会。</p><h1 id=需求>需求<a hidden class=anchor aria-hidden=true href=#需求>#</a></h1><p>基本是目前虚拟机上 OpenWRT 功能的移植：</p><ol><li>Wireguard</li></ol><p>能通过 Wireguard 结合家里的公网 ip 从公司访问家里网络</p><ol start=2><li>自定义域名</li></ol><p>通过自定义域名和 Nginx 实现域名访问自部署的服务，不用记 ip 和端口，不用维护
dashboard 服务</p><ol start=3><li>DDNS 服务</li></ol><p>自动更新公网 ip，防止每次拨号之后 Wireguard 失联</p><ol start=4><li>KMS 服务</li></ol><p>windows 激活</p><ol start=5><li>懂的都懂需求</li></ol><p>如题，不做展开</p><h1 id=r2s-系统安装>R2S 系统安装<a hidden class=anchor aria-hidden=true href=#r2s-系统安装>#</a></h1><p>下面我们就一步步实现上面的需求，首先是系统的选用，依照官网介绍选择官方自己维护编译的
OpenWRT 发行版，对与 Docker
目前是没有需求的，但为了防止以后有需要的时候还得自己安装，所以我们直接一步到位，选择官方基于
OpenWrt 22.03 构建的带 Docker
的<a href=https://download.friendlyelec.com/NanoPiR2S>FriendlyWrt 固件</a></p><p><img loading=lazy src=https://img.linkzz.eu.org/main/images/2023/08/968e910e8c6bb4e162bf5dcc779f0519.png alt=image.png></p><p>接下来就是烧录固件到 TF 卡，插电开机。</p><h2 id=系统配置>系统配置<a hidden class=anchor aria-hidden=true href=#系统配置>#</a></h2><p>插上网线，更改电脑 ip 为<code>192.168.2.100</code>，系统默认 ip
为<code>192.168.2.1</code>，配置的客户机 ip 也要在<code>192.168.2.0/24</code>网段才能互访，现在使用
ssh 访问 openwrt 后台:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ssh root@192.168.2.1
</code></pre></div><p>默认密码为<code>password</code> 首先改个安全密码</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>passwd root
</code></pre></div><h3 id=修改-ip-地址>修改 ip 地址<a hidden class=anchor aria-hidden=true href=#修改-ip-地址>#</a></h3><p>首先修改 ip 使其具有互联网访问能力</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>vi /etc/config/network
</code></pre></div><p>找到<code>config interface 'lan'</code>处，修改如下:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>config interface &#39;lan&#39;
        option device &#39;br-lan&#39;
        option proto &#39;static&#39;
        option netmask &#39;255.255.255.0&#39;
        option ip6assign &#39;60&#39;
        option ipaddr &#39;192.168.5.99&#39;
        option gateway &#39;192.168.5.1&#39;
</code></pre></div><p>上面掩码和网关需要依据家里的网络环境修改，我的虚拟机 openwrt
目前具有良好的网络访问能力，所以网关设置为了虚拟机 openwrt 的
ip，还有要注意的就是 ip 不能冲突了。</p><h3 id=修改-dns>修改 DNS<a hidden class=anchor aria-hidden=true href=#修改-dns>#</a></h3><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>vi /etc/config/dhcp
</code></pre></div><p>dnsmasq 配置选项下新增<code>list server '192.168.5.1'</code> dncp &lsquo;lan'配置选项下 option
ignore 要改为 1，对应 web 界面的忽略此接口</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>config dnsmasq
        option domainneeded &#39;1&#39;
        option boguspriv &#39;1&#39;
        option filterwin2k &#39;0&#39;
        option localise_queries &#39;1&#39;
        option rebind_protection &#39;1&#39;
        option rebind_localhost &#39;1&#39;
        option local &#39;/lan/&#39;
        option domain &#39;lan&#39;
        option expandhosts &#39;1&#39;
        option nonegcache &#39;0&#39;
        option authoritative &#39;1&#39;
        option readethers &#39;1&#39;
        option leasefile &#39;/tmp/dhcp.leases&#39;
        option resolvfile &#39;/tmp/resolv.conf.d/resolv.conf.auto&#39;
        option nonwildcard &#39;1&#39;
        option localservice &#39;1&#39;
        option ednspacket_max &#39;1232&#39;
        option confdir &#39;/tmp/dnsmasq.d&#39;
        list server &#39;192.168.5.1&#39;

config dhcp &#39;lan&#39;
        option interface &#39;lan&#39;
        option start &#39;100&#39;
        option limit &#39;150&#39;
        option leasetime &#39;12h&#39;
        option dhcpv4 &#39;server&#39;
        option dhcpv6 &#39;server&#39;
        option ra &#39;server&#39;
        list ra_flags &#39;managed-config&#39;
        list ra_flags &#39;other-config&#39;
        option ignore &#39;1&#39;

config dhcp &#39;wan&#39;
        option interface &#39;wan&#39;
        option ignore &#39;1&#39;

config odhcpd &#39;odhcpd&#39;
        option maindhcp &#39;0&#39;
        option leasefile &#39;/tmp/hosts/odhcpd&#39;
        option leasetrigger &#39;/usr/sbin/odhcpd-update&#39;
        option loglevel &#39;4&#39;
</code></pre></div><p>执行命令检测互谅网访问能力</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl https://baidu.com
</code></pre></div><p>证书报错</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>root@FriendlyWrt:~# curl https://baidu.com
curl: (60) Cert verify failed: BADCERT_FUTURE
More details here: https://curl.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.
</code></pre></div><p>网络是联通了互联网的，其他机器也能正常上网，查了一下是机器时间有问题：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@FriendlyWrt:~# date
Fri Jan <span class=m>22</span> 17:07:48 CST <span class=m>2016</span>
</code></pre></div><p>查看 ntp 服务</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@FriendlyWrt:~# ps <span class=p>|</span> grep ntp
 <span class=m>3942</span> root      <span class=m>2592</span> S    <span class=o>{</span>ntpd<span class=o>}</span> /sbin/ujail -t <span class=m>5</span> -n ntpd -U ntp -G ntp -C /etc/capabilities/ntpd.json -c -u -r /bin/ubus -r /usr/bin/env -r /usr/bin/jshn -r /usr/sbin/ntpd-hotplug -r /usr/share/libubox/jshn.s
 <span class=m>3954</span> ntp       <span class=m>1320</span> S    /usr/sbin/ntpd -n -N -S /usr/sbin/ntpd-hotplug -p 0.openwrt.pool.ntp.org -p 1.openwrt.pool.ntp.org -p 2.openwrt.pool.ntp.org -p 3.openwrt.pool.ntp.org
 <span class=m>5678</span> root      <span class=m>1572</span> S    grep ntp
</code></pre></div><p>修改 ntp 为阿里 ntp</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>vi /etc/config/system
</code></pre></div><div class=highlight><pre class=chroma><code class=language-text data-lang=text>config system
        option log_size &#39;64&#39;
        option urandom_seed &#39;0&#39;
        option hostname &#39;FriendlyWrt&#39;
        option ttylogin &#39;1&#39;
        option timezone &#39;CST-8&#39;
        option zonename &#39;Asia/Shanghai&#39;

config timeserver &#39;ntp&#39;
        option enabled &#39;1&#39;
        option enable_server &#39;0&#39;
        list server &#39;ntp.aliyun.com&#39;
        list server &#39;ntp1.aliyun.com&#39;
        list server &#39;ntp2.aliyun.com&#39;
        list server &#39;ntp3.aliyun.com&#39;

config led &#39;led_wan&#39;
        option name &#39;WAN&#39;
        option sysfs &#39;wan_led&#39;
        option trigger &#39;netdev&#39;
        option mode &#39;link tx rx&#39;
        option dev &#39;eth0&#39;

config led &#39;led_lan&#39;
        option name &#39;LAN&#39;
        option sysfs &#39;lan_led&#39;
        option trigger &#39;netdev&#39;
        option mode &#39;link tx rx&#39;
        option dev &#39;eth1&#39;
</code></pre></div><p>重启服务</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>/etc/init.d/sysntpd restart
</code></pre></div><p>查看时间</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@FriendlyWrt:~# date
Mon Aug  <span class=m>7</span> 14:56:10 CST <span class=m>2023</span>
</code></pre></div><p>查看证书问题是否报错</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@FriendlyWrt:~# curl https://baidu.com
&lt;html&gt;
&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;
&lt;body <span class=nv>bgcolor</span><span class=o>=</span><span class=s2>&#34;white&#34;</span>&gt;
&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;bfe/1.0.8.18&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><p>正常的 302 重定向</p><h3 id=修改源可选>修改源（可选）<a hidden class=anchor aria-hidden=true href=#修改源可选>#</a></h3><p>FriendlyWrt 固件使用的是腾讯源, 由于虚拟机 openwrt
使用的是清华源，所以保持一致以免软件包版本冲突:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sed -i -e <span class=s1>&#39;s/mirrors.cloud.tencent.com/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /etc/opkg/distfeeds.conf
</code></pre></div><p>更新索引</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>opkg update
</code></pre></div><h2 id=wireguard>Wireguard<a hidden class=anchor aria-hidden=true href=#wireguard>#</a></h2><h3 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h3><p>系统配置好之后添加 Wireguard 内核模块和工具包</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>opkg install kmod-wireguard wireguard-tools
</code></pre></div><p>检查内核是否加载了 wireguard 模块</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lsmod <span class=p>|</span> grep wireguard
</code></pre></div><p>出现如下字样说明成功加载 wireguard 模块</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@FriendlyWrt:~# lsmod <span class=p>|</span> grep wireguard
wireguard              <span class=m>77824</span>  <span class=m>0</span>
libchacha20poly1305    <span class=m>16384</span>  <span class=m>1</span> wireguard
libcurve25519_generic    <span class=m>40960</span>  <span class=m>1</span> wireguard
udp_tunnel             <span class=m>24576</span>  <span class=m>3</span> l2tp_core,wireguard,vxlan
ip6_udp_tunnel         <span class=m>16384</span>  <span class=m>3</span> l2tp_core,wireguard,vxlan
</code></pre></div><p>生成公私钥对</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>wg genkey <span class=p>|</span> tee privatekey <span class=p>|</span> wg pubkey &gt; publickey
</code></pre></div><p>以上命令生成公私钥文件分别存储到<code>privatekey</code>和<code>publickey</code>中 配置 wireguard 接口</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>vi /etc/config/network
</code></pre></div><p>末尾添加以下内容, 大括号里的内容记得替换</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>config interface &#39;wg0&#39;
        option proto &#39;wireguard&#39;
        option private_key &#39;{private_key}&#39;
        option listen_port &#39;25378&#39;
        list addresses &#39;192.168.7.1&#39;
</code></pre></div><p>重启 network 服务</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>/etc/init.d/network restart
</code></pre></div><p>查看 wireguard 状态</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@FriendlyWrt:~# wg
interface: wg0
  public key: fTaGpi1YIlS6RTsWSjsHoWMHY1drWe/CTTOK/EUFTUE<span class=o>=</span>
  private key: <span class=o>(</span>hidden<span class=o>)</span>
  listening port: <span class=m>25378</span>
</code></pre></div><p>以上步骤也可以在 web 端进行，web 端需要安装 luci 支持：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>opkg install luci-i18n-wireguard-zh-cn
</code></pre></div><p>Web 端</p><p><img loading=lazy src=https://img.linkzz.eu.org/main/images/2023/08/ac239cd6c3d4636796746f5afbf03457.png alt=image.png></p><h3 id=公网访问>公网访问<a hidden class=anchor aria-hidden=true href=#公网访问>#</a></h3><p>目前我的家庭网络拓扑如下：</p><p><img loading=lazy src=https://img.linkzz.eu.org/main/images/2023/08/7f8eb8dd9d5963624cebd1e040a243f6.png alt=image.png></p><p>坐标上海，电信光猫拨号，有公网 ip，可以看到虚拟机 openwrt 位于 2
级路由之下，这是要将 openwrt
的端口转发出去需要二级路由<code>AC-68U</code>转发一次，再经过光猫转发一次，较为麻烦，所以在安全的前提下我在电信
app 上面将二级路由 DMZ 出去，开启二级路由防火墙，再使用二级路由的端口转发功能将
wireguard
端口转发出去即可，这样公网接管了二级路由的所有端口，以后也方便配置各种端口
转发。</p><blockquote><p>注意千万别将 openwrt 的 web 端口 80 和 ssh 端口 22
转发到公网，这样黑客扫到开盒是早晚的事。</p></blockquote><h3 id=windows-客户端配置>windows 客户端配置<a hidden class=anchor aria-hidden=true href=#windows-客户端配置>#</a></h3><p>windows
使用官方的<a href=https://download.wireguard.com/windows-client/>wireguard 客户端</a>，新建空隧道：</p><p><img loading=lazy src=https://img.linkzz.eu.org/main/images/2023/08/5d9972bc64588156eaa6bf1e0297b551.png alt=image.png></p><p>会自动生成公私钥对，然后填写配置:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>[Interface]
PrivateKey = {privatekey}
Address = 192.168.7.2/32
DNS = 192.168.7.1
MTU = 1300

[Peer]
PublicKey = {openwrt_publickey}
AllowedIPs = 192.168.7.0/24,192.168.5.0/24
Endpoint = {公网ip}:{转发端口}
PersistentKeepalive = 25
</code></pre></div><ul><li>Interface 配置<ul><li>PrivateKey: 自动生成的私钥，不需要修改</li><li>Address: 当前节点的 ip 地址，需要和后面配置的对端地址相同</li><li>DNS: 使用 openwrt 提供的 dns
服务，用到自定义域名的时候有用，在公司也能访问内网的域名</li><li>MTU: 默认
1500，影响发包的性能，这个需要自己去试，小一点可以提升一点网络性能，不是太在意的话默认
1500 即可。</li></ul></li><li>Peer 配置<ul><li>PublicKey: 填写 openwrt 的公钥</li><li>AllowedIPs: 允许访问的网段，这里填写家里内网网段即可，如果需要 wireguard
作为所有网段隧道填写 0.0.0.0/0，需要 openwrt 防火墙配置正确才能访问互联网。</li><li>Endpoint: 公网转发出来的 wireguard 地址和端口</li><li>PersistentKeepalive: 保活时间，设置为 25s</li></ul></li></ul><h3 id=配置对端>配置对端<a hidden class=anchor aria-hidden=true href=#配置对端>#</a></h3><p>windows 配置完之后还没完，openwrt 上还要进行相应配置：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>vi /etc/config/network
</code></pre></div><p>添加如下配置：</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>config wireguard_wg0
        option route_allowed_ips &#39;1&#39;
        option persistent_keepalive &#39;25&#39;
        option public_key &#39;VM3DZLzhtpkE0w1VgUmeRSuoX/6mgVMlJWtnynomUXg=&#39;
        option description &#39;Worklaptop&#39;
        list allowed_ips &#39;192.168.7.2&#39;
</code></pre></div><p>重启网络服务</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>/etc/init.d/network restart
</code></pre></div><p>windows 客户端点击连接：</p><p><img loading=lazy src=https://img.linkzz.eu.org/main/images/2023/08/422c91142fb949cab4abe6428036f972.png alt=image.png></p><p>流量收发正常即表示连接成功，ping 一下网关测试一下：</p><p><img loading=lazy src=https://img.linkzz.eu.org/main/images/2023/08/14abc786923d364d48435f179e5733fd.png alt=image.png></p><p>对端连接成功，但是访问内网<code>192.168.5.0/24</code>网段显然是不行的，这是因为防火墙将来自
wireguard 的网络访问转发给 lan 接口，下面我们就开始配置防火墙。</p><h3 id=防火墙配置>防火墙配置<a hidden class=anchor aria-hidden=true href=#防火墙配置>#</a></h3><p>通过 openwrt Web 端，“网络” -> “防火墙” -> “NAT 规则”，配置一个地址的
nat，转发来自<code>192.168.7.0/24</code>网段的流量到 lan
接口，这样即可实现内网网段的访问，当然如果需要 wireguard
具备访问所有网段的能力，将目标地址设为任意即可。</p><p><img loading=lazy src=https://img.linkzz.eu.org/main/images/2023/08/3ed316779a109677b36d2c22ab8e629b.png alt=image.png></p><h1 id=小结>小结<a hidden class=anchor aria-hidden=true href=#小结>#</a></h1><p>本章我们实现了 openwrt 的第一个功能，外网访问内网即 VPN
的功能，让我们可以不用担心各种端口转发暴露内网风险，实现方便安全的访问家庭内网的能力，接下来我们继续实现第二个需求，自定义内网域名。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://linkzz.eu.org/tags/openwrt/>openwrt</a></li><li><a href=https://linkzz.eu.org/tags/wireguard/>wireguard</a></li></ul><nav class=paginav><a class=prev href=https://linkzz.eu.org/posts/oracle-blog-picture/><span class=title>« Prev</span><br><span>使用Oracle对象存储作为博客图床（一）</span></a>
<a class=next href=https://linkzz.eu.org/posts/awesome-windows-terminal/><span class=title>Next »</span><br><span>让Powershell更好用, Windows下目前最好用的终端工具-Windows Terminal折腾记</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://linkzz.eu.org/>Linkzz's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z" /></svg></a><script>let menu=document.getElementById('menu')
if(menu){menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script><script>document.querySelectorAll('pre > code').forEach((codeblock)=>{const container=codeblock.parentNode.parentNode;const copybutton=document.createElement('button');copybutton.classList.add('copy-code');copybutton.innerHTML='copy';function copyingDone(){copybutton.innerHTML='copied!';setTimeout(()=>{copybutton.innerHTML='copy';},2000);}
copybutton.addEventListener('click',(cb)=>{if('clipboard'in navigator){navigator.clipboard.writeText(codeblock.textContent);copyingDone();return;}
const range=document.createRange();range.selectNodeContents(codeblock);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{document.execCommand('copy');copyingDone();}catch(e){};selection.removeRange(range);});if(container.classList.contains("highlight")){container.appendChild(copybutton);}else if(container.parentNode.firstChild==container){}else if(codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);}else{codeblock.parentNode.appendChild(copybutton);}});</script></body></html>